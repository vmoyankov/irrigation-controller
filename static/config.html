<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Configuration</title>
    <link rel="stylesheet" href="/static/min.css">
    <style>
        .hr-box {
            width: 4rem;
        }
    </style>
    <script src="/static/form-to-json.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Device Configuration</h1>

    <div id="settings-group" style="display: none;">
    <div class="row">
        <div class="col">
            <label for="pumpPower">Pump Power</label>
        </div>
        <div class="col">
            <input class="hr-box" type="number" id="pumpPower" min="0" max="100" placeholder="0 - 100" /> %
        </div>
    </div>

    <div class="row">
        <div class="col">
          <label for="autorun">Automatic Irrigation</label>
        </div>
        <div class="col">
          <input type="checkbox" id="autorun" onchange="toggleAutorun()"/>
        </div>
    </div>

    <div class="row" id="schedule-group" style="display: none;">
        <div class="col">
            <label>Schedule (HH:MM)</label>
        </div>
        <div class="col">
            <input type="number" class="hr-box" id="schedule.hour" min="0" max="23" placeholder="0-23"
                oninput="formatHourInput(this)"/> : 
            <input type="number" class="hr-box" id="schedule.minute" min="0" max="59" placeholder="0-59"
                oninput="formatMinuteInput(this)"/>
          </div>
    </div>

    <h3>Volumes (ml)</h3>
    <div class="row">
        <div class="col" >
            <label for="volumes.1">Valve 1</label>
            <input type="number" id="volumes.1" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.2">Valve 2</label>
            <input type="number" id="volumes.2" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.3">Valve 3</label>
            <input type="number" id="volumes.3" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.4">Valve 4</label>
            <input type="number" id="volumes.4" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.5">Valve 5</label>
            <input type="number" id="volumes.5" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.6">Valve 6</label>
            <input type="number" id="volumes.6" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.7">Valve 7</label>
            <input type="number" id="volumes.7" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.8">Valve 8</label>
            <input type="number" id="volumes.8" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.9">Valve 9</label>
            <input type="number" id="volumes.9" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.10">Valve 10</label>
            <input type="number" id="volumes.10" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.11">Valve 11</label>
            <input type="number" id="volumes.11" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
        <div class="col" >
            <label for="volumes.12">Valve 12</label>
            <input type="number" id="volumes.12" class="volume-input" min="10" max="2000" placeholder="" />
        </div>
    </div>
    </div>

    <div class="row">
        <div class="col">
          <button type="button" class="btn-green" id="save-button" onclick="saveConfig()">Save Configuration</button>
        </div>
        <div class="col">
          <button type="button" id="cancel-button" onclick="window.history.back()">Cancel</button>
        </div>
       <div class="col">
          <button type="button" class="btn-blue" id="tank-button" onclick="resetTank()">Reset Tank Level</button>
        </div>
    </div>
    <div class="row">
        <p id="status"></p>
    </div>
</div>
<script>
    fetch('/config').then(r=>r.json()).then(d=>jsonToForm(d))
    .then(()=>document.getElementById('settings-group').style.display = 'block')
    .then(()=>toggleAutorun());

    function saveConfig() {
        console.log('Saving configuration');
        const data = formToJson('settings-group');
        fetch('/config', {
            method: 'POST',
            body: JSON.stringify(data)
        });
        window.location.href = "/";
    }

    function resetTank() {
        if (!confirm('Are you sure you want to reset the tank level? This can not be undone.')) return;
        fetch('/reset-tank', {
            method: 'POST',
        });
        alert('Tank level was reset');
        window.location.href = "/";
    }

    function toggleAutorun() {
        const autorun = document.getElementById('autorun');
        const scheduleGroup = document.getElementById('schedule-group');
        if (autorun.checked) {
            scheduleGroup.style.display = 'flex';
        } else {
            scheduleGroup.style.display = 'none';
        }
    }

    // Format the minute input to be 2 digits
    function formatMinuteInput(input) {
        v = parseInt(input.value);
        if (isNaN(v)) v = 0;
        v = Math.min(Math.max(v, 0), 59);
        input.value = v.toString().padStart(2, '0');
    }
    function formatHourInput(input) {
        v = parseInt(input.value);
        if (isNaN(v)) v = 0;
        v = Math.min(Math.max(v, 0), 23);
        input.value = v.toString().padStart(2, '0');
    }
</script>

</body>
</html>
